# Build Artix Live ISO on GitHub Actions
# 
# Fix for overlayfs issue: Mount workspace directory from host filesystem
# into container and use it for artools build directory. This avoids nested
# overlayfs (overlayfs on top of overlayfs) which is not supported by the
# Linux kernel. The GitHub Actions workspace is on the host ext4 filesystem,
# not overlayfs, so it can be used as an overlayfs upperdir.


name: Build and Release Artix Live ISO

on:
  push:

permissions:
  contents: write

jobs:
  build-iso:
    runs-on: ubuntu-latest
    container:
      image: artixlinux/artixlinux:latest
      options: --privileged
      volumes:
        - /home/runner/work:/workspace

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pacman & update keys
        run: |
          pacman-key --init
          pacman -Syu --noconfirm
          pacman -S --noconfirm artix-keyring
          pacman-key --populate artix
          
      - name: Install build tools
        run: |
          pacman -S --noconfirm artools iso-profiles git base-devel squashfs-tools dosfstools mtools

      - name: Build ISO
        run: |
          # Use workspace directory (host filesystem) instead of container overlayfs
          # This avoids the nested overlayfs issue
          mkdir -p /workspace/artools-build
          ln -s /workspace/artools-build /var/lib/artools
          
          # Clone and set up iso-profiles
          git clone https://gitea.artixlinux.org/artix/iso-profiles
          mv /usr/share/artools/iso-profiles /tmp/
          mv iso-profiles /usr/share/artools/
          ls /usr/share/artools/iso-profiles/
          
          # Build ISO
          buildiso -p base         
          #buildiso -p lxqt -q
          #mkdir -p ~/.config/artools/ ~/artools-workspace/
          #cp /etc/artools/artools-base.conf /etc/artools/artools-iso.conf /etc/artools/artools-pkg.conf ~/.config/artools/
          #cp -r /usr/share/artools/iso-profiles ~/artools-workspace/
          #ls ~
          #buildiso -p lxqt

      - name: Find built ISO
        id: find_iso
        run: |
          echo "ISO_PATH=$(find /workspace/artools-build/buildiso -name '*.iso' | head -n1)" >> $GITHUB_ENV

      - name: Upload ISO to release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ISO_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
