# Build Artix Live ISO on GitHub Actions
# 
# Fix for overlayfs issue: Use GitHub Actions workspace directory for artools
# build output. The workspace is mounted from the host filesystem (ext4) which
# is not overlayfs. This avoids nested overlayfs (overlayfs on top of overlayfs)
# which is not supported by the Linux kernel.


name: Build and Release Artix Live ISO

on:
  push:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-iso:
    runs-on: ubuntu-latest
    container:
      image: artixlinux/artixlinux:latest
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pacman & update keys
        run: |
          pacman-key --init
          pacman -Syu --noconfirm
          pacman -S --noconfirm artix-keyring
          pacman-key --populate artix
          
      - name: Install build tools
        run: |
          pacman -S --noconfirm artools iso-profiles git base-devel squashfs-tools dosfstools mtools lvm2
          # According to https://packages.artixlinux.org/packages/world/any/iso-profiles/ the files should be installed by the iso-profiles package
          # pacman -Qi iso-profiles
          # pacman -Ql iso-profiles

          find /usr/share/artools/iso-profiles/ -xtype l || true  # Find broken symlinks

          # Clone and set up iso-profiles
          git clone https://gitea.artixlinux.org/artix/iso-profiles
          #( cd iso-profiles ; git checkout community )
          mv /usr/share/artools/iso-profiles /tmp/
          mv iso-profiles /usr/share/artools/
          #ls /usr/share/artools/iso-profiles/

          find /usr/share/artools/iso-profiles/ -xtype l # Find broken symlinks
          file '/usr/share/artools/iso-profiles/xfce/root-overlay/etc/environment'
          file '/usr/share/artools/iso-profiles/xfce/root-overlay/etc/lightdm/lightdm-gtk-greeter.conf'
          file '/usr/share/artools/iso-profiles/xfce/root-overlay/etc/local.d'
          file '/usr/share/artools/iso-profiles/xfce/root-overlay/etc/pacman.conf'
          ls -lhR '/usr/share/artools/iso-profiles/xfce/root-overlay/etc/environment'
          ls -lhR '/usr/share/artools/iso-profiles/xfce/root-overlay/etc/lightdm/lightdm-gtk-greeter.conf'
          ls -lhR '/usr/share/artools/iso-profiles/xfce/root-overlay/etc/local.d'
          ls -lhR '/usr/share/artools/iso-profiles/xfce/root-overlay/etc/pacman.conf'

      - name: Build ISO
        run: |
          # Use GitHub workspace directory (host filesystem) for artools build
          # GitHub Actions mounts the workspace from host, which is not overlayfs
          # This avoids the nested overlayfs issue
          mkdir -p $GITHUB_WORKSPACE/artools-build
          ln -sf $GITHUB_WORKSPACE/artools-build /var/lib/artools

          ## Try to pin Artix Linux
          #mkdir -p /usr/share/artools/iso-profiles/common/root-overlay/etc
          #cat > /usr/share/artools/iso-profiles/common/root-overlay/etc/pacman.conf << 'EOF'
          ##
          ## /etc/pacman.conf
          ##
          ## See the pacman.conf(5) manpage for option and repository directives
          #
          #[options]
          #HoldPkg     = pacman glibc
          #Architecture = auto
          #
          ##
          ## Pin Arch Linux to a certain date
          ##
          #
          #[core]
          #Server = https://archive.artixlinux.org/repos/2025/09/15/$repo/os/$arch
          #Server = https://archive.archlinux.org/repos/2025/09/15/$repo/os/$arch
          #
          #[extra]
          #Server = https://archive.artixlinux.org/repos/2025/09/15/$repo/os/$arch
          #Server = https://archive.archlinux.org/repos/2025/09/15/$repo/os/$arch
          #EOF
          #
          # Build ISO
          buildiso -p xfce

      - name: Upload ISO
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          pacman -S --noconfirm wget
          wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh
          ISO_PATH=$(find /github/home/artools-workspace/iso/*/*.iso | head -n 1)
          echo $ISO_PATH
          bash -ex upload.sh "$ISO_PATH"
